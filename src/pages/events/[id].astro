---
import { getImage } from 'astro:assets'
import { getCollection, getEntry } from 'astro:content'
import sitemap from 'sitemap-ext:config'
import type { GetStaticPaths } from 'astro'
import Event from '@/components/Event.astro'
import Layout from '@/layouts/Layout.astro'
import { dateOnly } from '@/tools/events'
import type { Event as EventType, FullEvent } from '@/types'

export const getStaticPaths: GetStaticPaths = async () => {
  const events = await getCollection('events')
  return events.map((entry) => ({
    params: {
      id: entry.id,
    },
    props: {
      entry,
    },
  }))
}

// Sitemap-Konfiguration für dynamische Routen
sitemap(async ({ setSitemap }) => {
  const events = await getCollection('events')
  setSitemap(
    events.map((event) => ({
      params: { id: event.id },
      sitemap: !event.data.noindex,
    })),
  )
})

const { entry } = Astro.props as { entry: EventType }
const event = {
  ...entry,
  data: {
    ...entry.data,
    ...(entry.data.location
      ? {
          location: await getEntry(entry.data.location),
        }
      : {}),
    ...(entry.data.organizer
      ? {
          organizer: await getEntry(entry.data.organizer),
        }
      : {}),
  },
} as FullEvent

const imageUrl = entry.data.image
  ? (await getImage({ src: event.data.image?.src || '' })).src
  : undefined

const ogImage = entry.data.image
  ? await getImage({ src: event.data.image?.src || '', width: 1200 })
  : undefined

// Prüfen, ob das Event in der Vergangenheit liegt
const eventEndDate = event.data.endDate || event.data.startDate
const endOfEventDay = new Date(eventEndDate)
endOfEventDay.setHours(23, 59, 59, 999)
const isPastEvent = endOfEventDay < new Date()
const eventStatus = isPastEvent
  ? 'https://schema.org/EventCompleted'
  : 'https://schema.org/EventScheduled'

const formatDateForSchema = (date: Date, allDay: boolean) => {
  if (allDay) {
    return date.toISOString().split('T')[0]
  }
  return date.toISOString()
}

// Felder ausfiltern, die vor der Aufnahme in JSON-LD speziell formatiert oder nicht übernommen werden sollen
const {
  noindex,
  allDay,
  location,
  organizer,
  image,
  startDate,
  endDate,
  ...schemaData
} = event.data
const googleStructuredEventData = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Event',
  eventStatus,
  ...schemaData,
  startDate: formatDateForSchema(event.data.startDate, event.data.allDay),
  ...(event.data.endDate
    ? { endDate: formatDateForSchema(event.data.endDate, event.data.allDay) }
    : {}),
  ...(event.data.organizer ? { organizer: event.data.organizer.data } : {}),
  ...(event.data.location ? { location: event.data.location.data } : {}),
  ...(imageUrl ? { image: imageUrl } : {}),
})

// Spezifischerer Titel mit Datum und Ort
const locationName = event.data.location?.data.name
const titleParts = [event.data.name, dateOnly(event.data.startDate)]
if (locationName) {
  titleParts.push(locationName)
}
const pageTitle = titleParts.join(' – ')
---

<Layout title={pageTitle} description={event?.data.description} ogImage={ogImage?.src} ogType="event" noindex={entry.data.noindex}>
  <Event event={event} />
  <script is:inline type="application/ld+json" set:html={googleStructuredEventData} />
</Layout>
